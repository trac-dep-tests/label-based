name: Issue Type Setter
on:
  issues:
    types: [opened]

jobs:
  set-type:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            async function setIssueType() {
              const issue = context.payload.issue;
              const body = issue.body;
              
              // Extract the Type field value
              const typeMatch = body.match(/### Type\s*\n\n(.+?)(?:\n\n|$)/s);
              if (!typeMatch) return;
              
              const type = typeMatch[1].trim();
              let issueType = type === 'Bug' ? 'BUG' : 'ISSUE';
              
              // First get the repository ID
              const repoQuery = `
                query($owner: String!, $name: String!) {
                  repository(owner: $owner, name: $name) {
                    id
                  }
                }
              `;
              
              const repoData = await github.graphql(repoQuery, {
                owner: context.repo.owner,
                name: context.repo.repo
              });
              
              // Now update the issue type
              const mutation = `
                mutation($repositoryId: ID!, $issueId: ID!, $type: IssueType!) {
                  updateIssue(input: {
                    repositoryId: $repositoryId,
                    id: $issueId,
                    issueType: $type
                  }) {
                    issue {
                      id
                    }
                  }
                }
              `;
              
              try {
                await github.graphql(mutation, {
                  repositoryId: repoData.repository.id,
                  issueId: issue.node_id,
                  type: issueType
                });
                
                console.log(`Set issue #${issue.number} type to ${issueType}`);
              } catch (error) {
                console.error('Error setting issue type:', error);
                console.error('Error details:', JSON.stringify(error, null, 2));
              }
            }
            
            await setIssueType();